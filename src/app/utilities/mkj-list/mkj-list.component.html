<p-table
    #table
    [value]="values"
    [loading]="loading$()"
    [scrollable]="true"
    [class.p-disabled]="disabled"
    [lazy]="configuration.lazyLoad"
    [paginator]="configuration.lazyLoad"
    [rows]="pageSize"
    [totalRecords]="totalCount"
    (onLazyLoad)="onLazyLoad($event)"
    stateStorage="session"
    [stateKey]="configuration.listName + '-list'"
    rowExpandMode="single"
    dataKey="id"
    [selectionMode]="configuration.selectionMode ?? null"
    [rowHover]="configuration.selectionMode != null"
    [(selection)]="selectedRow"
    (onRowSelect)="table.toggleRow($event.data)"
    [sortField]="configuration.sort?.field"
    [sortOrder]="configuration.sort?.order"
    [globalFilterFields]="configuration.globalFilter?.fields"
    (onRowReorder)="onRowReordered($event)"
    styleClass="p-datatable-striped"
    responsiveLayout="scroll"
>
    <ng-template pTemplate="caption">
        <div
            class="flex flex-column md:flex-row md:justify-content-between align-items-center"
        >
            <div *ngIf="configuration.showTotalCount" class="m-2">
                Anzahl:
                {{ totalCount }}
            </div>
            <mkj-text-input
                *ngIf="configuration.globalFilter != null"
                iconRight="pi pi-search"
                [value]="table.filters?.global?.value"
                (valueChange)="
                    table.filterGlobal(
                        $event,
                        configuration.globalfilter?.matchMode ?? 'contains'
                    )
                "
                placeholder="Suchen..."
            />
        </div>

        <ng-template
            [ngTemplateOutlet]="templateMap?.caption"
            [ngTemplateOutletContext]="{ $implicit: value }"
        ></ng-template>
    </ng-template>

    <ng-template #headerCell let-col>
        {{ col.header }}
        <p-sortIcon *ngIf="col.sortable" [field]="col.field"></p-sortIcon>
        <p-columnFilter
            *ngIf="col.filter != null"
            [field]="col.field"
            matchMode="equals"
            display="menu"
            [showOperator]="false"
            [showClearButton]="false"
            [showApplyButton]="false"
            [showMatchModes]="false"
            [showAddButton]="false"
            [hideOnClear]="true"
        >
            <ng-template
                pTemplate="filter"
                let-value
                let-filter="filterCallback"
            >
                <p-dropdown
                    [ngModel]="value"
                    [options]="col.filter.filterOptions"
                    (onChange)="filter($event.value)"
                    placeholder="Filter"
                >
                    <ng-template let-option pTemplate="item">
                        <span>{{ option.label }}</span>
                    </ng-template>
                </p-dropdown>
            </ng-template>
        </p-columnFilter>
    </ng-template>
    <ng-template *ngIf="!configuration.hideHeader" pTemplate="header"
        ><tr>
            <th *ngIf="rowReorder" class="w-2rem"></th>
            <ng-container *ngFor="let col of configuration.columns">
                <th
                    *ngIf="col.sortable"
                    [class]="col.styleClass"
                    [pSortableColumn]="col.field"
                >
                    <ng-template
                        [ngTemplateOutlet]="headerCell"
                        [ngTemplateOutletContext]="{ $implicit: col }"
                    ></ng-template>
                </th>
                <th *ngIf="!col.sortable" [class]="col.styleClass">
                    <ng-template
                        [ngTemplateOutlet]="headerCell"
                        [ngTemplateOutletContext]="{ $implicit: col }"
                    ></ng-template>
                </th>
            </ng-container>
        </tr>
    </ng-template>
    <ng-template
        pTemplate="body"
        let-value
        let-expanded="expanded"
        let-rowIndex="rowIndex"
    >
        <tr
            [pSelectableRow]="value"
            [pSelectableRowIndex]="rowIndex"
            [pReorderableRow]="rowIndex"
            (dblclick)="onDoubleClick.emit(value)"
        >
            <td *ngIf="rowReorder" class="w-2rem">
                <span class="pi pi-bars" pReorderableRowHandle></span>
            </td>
            <td
                *ngFor="let col of configuration.columns"
                [class]="col.styleClass"
            >
                <mkj-list-cell
                    [value]="value"
                    [colConfig]="col"
                    [templateMap]="templateMap"
                ></mkj-list-cell>
            </td>
        </tr>
    </ng-template>
    <ng-template
        *ngIf="templateMap?.rowexpansion != null"
        pTemplate="rowexpansion"
        let-value
    >
        <tr>
            <td colspan="200">
                <ng-template
                    [ngTemplateOutlet]="templateMap.rowexpansion"
                    [ngTemplateOutletContext]="{ $implicit: value }"
                ></ng-template>
            </td>
        </tr>
    </ng-template>
</p-table>
