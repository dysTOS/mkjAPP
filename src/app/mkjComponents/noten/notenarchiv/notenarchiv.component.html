<app-mkj-toolbar
    [showAddButton]="true"
    [addButtonPermissions]="['create noten']"
    (clickAdd)="openEditDialog()"
    addButtonTooltip="Noten anlegen"
    [headerLeft]="'Notenarchiv'"
></app-mkj-toolbar>

<p-table
    #notenTable
    [value]="notenArray"
    [loading]="loading"
    [globalFilterFields]="['titel', 'komponist', 'gattung', 'inventarId']"
    styleClass="p-datatable-striped p-datatable-sm p-datatable-noten rowexpand-table"
    dataKey="id"
    responsiveLayout="scroll"
    stateStorage="session"
    stateKey="notenTable-session"
    rowExpandMode="single"
    [(selection)]="selectedRow"
    [rowHover]="true"
    dataKey="id"
    selectionMode="single"
    (onFilter)="setFilteredRows($event)"
>
    <ng-template pTemplate="caption">
        <div
            class="p-d-flex p-flex-column p-flex-md-row p-jc-md-between p-ai-center"
        >
            <div class="p-m-2">
                Anzahl:
                {{ selectedNoten ? selectedNoten?.length + "/" : ""
                }}{{ notenArray?.length }}
            </div>

            <span class="p-input-icon-left">
                <i class="pi pi-search"></i>
                <input
                    pInputText
                    type="text"
                    [value]="globalFilterText"
                    (input)="
                        notenTable.filterGlobal($event.target.value, 'contains')
                    "
                    placeholder="Suchen..."
                />
            </span>
        </div>
    </ng-template>
    <ng-template pTemplate="header"
        ><tr>
            <th pSortableColumn="inventarId">
                Inv. Nr <p-sortIcon field="inventarId"></p-sortIcon>
            </th>
            <th pSortableColumn="titel">
                Titel <p-sortIcon field="titel"></p-sortIcon>
            </th>
            <th class="not-on-small">Komponist</th>
            <th class="not-on-small">Arrangeur</th>
            <th class="not-on-small">Verlag</th>
            <th class="not-on-small">Gattung</th>
            <th class="not-on-small"></th>
        </tr>
    </ng-template>
    <ng-template
        pTemplate="body"
        let-noten
        let-expanded="expanded"
        let-rowIndex="rowIndex"
    >
        <tr
            [pSelectableRow]="noten"
            [pSelectableRowIndex]="rowIndex"
            [pRowToggler]="noten"
        >
            <td>{{ noten.inventarId }}</td>
            <td>
                {{ noten.titel }}
            </td>
            <td class="not-on-small">
                {{ noten.komponist }}
            </td>
            <td class="not-on-small">{{ noten.arrangeur }}</td>
            <td class="not-on-small">{{ noten.verlag }}</td>
            <td class="not-on-small">{{ noten.gattung }}</td>
            <td class="not-on-small">
                <div class="p-d-flex buttons-hide">
                    <button
                        *visibleFor="['noten_save']"
                        pButton
                        pRipple
                        icon="pi pi-pencil"
                        class="p-button-text p-button-sm p-button-info p-mr-1"
                        (click)="openEditDialog(noten)"
                        pTooltip="Bearbeiten"
                        tooltipPosition="left"
                    ></button>
                    <button
                        *visibleFor="['noten_delete']"
                        pButton
                        pRipple
                        icon="pi pi-trash"
                        class="p-button-text p-button-sm p-button-danger"
                        (click)="deleteNoten(noten)"
                        pTooltip="Löschen"
                        tooltipPosition="left"
                    ></button>
                </div>
            </td>
        </tr>
    </ng-template>
    <ng-template pTemplate="rowexpansion" let-noten>
        <tr>
            <td colspan="12">
                <div class="p-grid p-col-12 card">
                    <div *ngIf="noten.komponist" class="p-lg-3 p-md-4 p-sm-12">
                        <mkj-display-field
                            label="Komponist"
                            [displaystring]="noten.komponist"
                        ></mkj-display-field>
                    </div>
                    <div *ngIf="noten.arrangeur" class="p-lg-3 p-md-4 p-sm-12">
                        <mkj-display-field
                            label="Arrangeur"
                            [displaystring]="noten.arrangeur"
                        ></mkj-display-field>
                    </div>
                    <div *ngIf="noten.verlag" class="p-lg-3 p-md-4 p-sm-12">
                        <mkj-display-field
                            label="Verlag"
                            [displaystring]="noten.verlag"
                        ></mkj-display-field>
                    </div>
                    <div *ngIf="noten.gattung" class="p-lg-3 p-md-4 p-sm-12">
                        <mkj-display-field
                            label="Gattung"
                            [displaystring]="noten.gattung"
                        ></mkj-display-field>
                    </div>
                    <div
                        *ngIf="noten.ausgeliehenAb"
                        class="p-lg-3 p-md-4 p-sm-12"
                    >
                        <mkj-display-field
                            label="Ausgeliehen seit"
                            [displaystring]="noten.ausgeliehenAb | mkjDate"
                        ></mkj-display-field>
                    </div>
                    <div
                        *ngIf="noten.ausgeliehenVon"
                        class="p-lg-3 p-md-4 p-sm-12"
                    >
                        <mkj-display-field
                            label="Ausgeliehen von"
                            [displaystring]="noten.ausgeliehenVon"
                        ></mkj-display-field>
                    </div>
                    <div
                        *ngIf="noten.aufbewahrungsort"
                        class="p-lg-3 p-md-4 p-sm-12"
                    >
                        <mkj-display-field
                            label="Aufbewahrungsort"
                            [displaystring]="noten.aufbewahrungsort"
                        ></mkj-display-field>
                    </div>
                    <div
                        *ngIf="noten.anmerkungen"
                        class="p-lg-6 p-md-12 p-sm-12"
                    >
                        <mkj-display-field
                            label="Anmerkungen"
                            [displaystring]="noten.anmerkungen"
                        ></mkj-display-field>
                    </div>
                </div>
                <div class="just-on-small">
                    <div class="p-col-12 p-d-flex p-jc-center">
                        <button
                            *visibleFor="['noten_save']"
                            pButton
                            pRipple
                            label="Bearbeiten"
                            icon="pi pi-pencil"
                            class="p-button-outlined p-button-sm p-button-info p-mr-1"
                            (click)="openEditDialog(noten)"
                        ></button>
                        <button
                            *visibleFor="['noten_delete']"
                            pButton
                            pRipple
                            icon="pi pi-trash"
                            label="Löschen"
                            class="p-button-outlined p-button-sm p-button-danger"
                            (click)="deleteNoten(noten)"
                        ></button>
                    </div>
                </div>
            </td>
        </tr>
    </ng-template>
</p-table>

<!-- Save/Update Noten -->
<p-dialog
    [(visible)]="editDialogVisible"
    [breakpoints]="{ '960px': '75vw', '640px': '100vw' }"
    [style]="{ width: '75vw' }"
    [header]="editNoten?.id ? 'Noten aktualisieren' : 'Noten erstellen'"
    [modal]="true"
    styleClass="p-fluid"
    position="top"
>
    <ng-template pTemplate="content">
        <app-noten-editor [(noten)]="editNoten"></app-noten-editor>
    </ng-template>
    <ng-template pTemplate="footer">
        <button
            pButton
            pRipple
            label="Abbrechen"
            icon="pi pi-times"
            class="p-button-text"
            (click)="cancelEdit()"
        ></button>
        <button
            pButton
            pRipple
            label="Speichern"
            [icon]="isAdding ? 'pi pi-spin pi-spinner' : 'pi pi-check'"
            [disabled]="isAdding"
            class="p-button-plain"
            (click)="saveNoten()"
        ></button
    ></ng-template>
</p-dialog>
